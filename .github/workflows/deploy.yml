name: Deploy to Render

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: production

    steps:
      # 1Ô∏è‚É£ R√©cup√©rer le code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Installer les d√©pendances du projet
      - name: Install dependencies
        run: npm ci

      # 3Ô∏è‚É£ V√©rifier qu'on est bien en prod
      - name: Check environment
        run: |
          if [ "$NODE_ENV" != "production" ]; then
            echo "üõë Pas en production, annulation du d√©ploiement"
            exit 0
          fi
          echo "‚úÖ Environnement de production d√©tect√©"

      # 4Ô∏è‚É£ Installer Render CLI via npm
      - name: Install Render CLI
        run: |
          npm install -g @render/cli
          render --version

      # 5Ô∏è‚É£ D√©ployer sur Render
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          CI: true
        run: |
          DEPLOY_OUTPUT=$(render deploys create ${{ secrets.RENDER_SERVICE_ID }} --confirm --output json)
          echo "$DEPLOY_OUTPUT"

          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP '(?<="url":")[^"]*')
          echo "üöÄ D√©ploiement lanc√© sur : $DEPLOY_URL"
