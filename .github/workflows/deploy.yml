name: Deploy to Render

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: production  # Force le mode production pour le d√©ploiement

    steps:
      # 1Ô∏è‚É£ R√©cup√©ration du code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Installation des d√©pendances
      - name: Install dependencies
        run: npm ci

      # 3Ô∏è‚É£ Lancer les tests
      - name: Run tests
        run: npm test

      # 4Ô∏è‚É£ V√©rifier que c'est bien en prod
      - name: Check environment
        run: |
          if [ "$NODE_ENV" != "production" ]; then
            echo "üõë Pas en production, annulation du d√©ploiement"
            exit 0
          fi
          echo "‚úÖ Environnement de production d√©tect√©, on continue..."

      # 5Ô∏è‚É£ Installation du Render CLI
      - name: Install Render CLI
        run: |
          curl -L https://github.com/render-oss/cli/releases/download/v1.1.0/cli_1.1.0_linux_amd64.zip -o render.zip
          unzip render.zip
          chmod +x render
          sudo mv render /usr/local/bin/render
          render --version

      # 6Ô∏è‚É£ D√©ploiement sur Render
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          CI: true
        run: |
          DEPLOY_OUTPUT=$(render deploys create ${{ secrets.RENDER_SERVICE_ID }} --confirm --output json)
          echo "$DEPLOY_OUTPUT"
          
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP '(?<="url":")[^"]*')
          echo "üöÄ D√©ploiement lanc√© sur : $DEPLOY_URL"
